\documentclass[aspectratio=169]{beamer}

\mode<presentation>
{
  \usetheme{default}
  \usecolortheme{default}
  \usefonttheme{default}
  \setbeamertemplate{navigation symbols}{}
  \setbeamertemplate{caption}[numbered]
  \setbeamertemplate{footline}[frame number]  % or "page number"
  \setbeamercolor{frametitle}{fg=white}
  \setbeamercolor{footline}{fg=black}
} 

\usepackage[english]{babel}
\usepackage[utf8x]{inputenc}
\usepackage{tikz}
\usepackage{courier}
\usepackage{array}
\usepackage{bold-extra}
\usepackage{minted}
\usepackage[thicklines]{cancel}
\usepackage{tabularx}

\xdefinecolor{dianablue}{rgb}{0.18,0.24,0.31}
\xdefinecolor{darkblue}{rgb}{0.1,0.1,0.7}
\xdefinecolor{darkgreen}{rgb}{0,0.5,0}
\xdefinecolor{darkgrey}{rgb}{0.35,0.35,0.35}
\xdefinecolor{darkorange}{rgb}{0.8,0.5,0}
\xdefinecolor{darkred}{rgb}{0.7,0,0}
\definecolor{darkgreen}{rgb}{0,0.6,0}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\title[2017-12-08-uproot-update]{\Huge uproot update}
\author{Jim Pivarski}
\institute{Princeton University -- DIANA-HEP}
\date{December 12, 2017}

\begin{document}

\logo{\pgfputat{\pgfxy(0.11, 7.4)}{\pgfbox[right,base]{\tikz{\filldraw[fill=dianablue, draw=none] (0 cm, 0 cm) rectangle (50 cm, 1 cm);}\mbox{\hspace{-8 cm}\includegraphics[height=1 cm]{princeton-logo-long.png}\includegraphics[height=1 cm]{diana-hep-logo-long.png}}}}}

\begin{frame}
  \titlepage
\end{frame}

\logo{\pgfputat{\pgfxy(0.11, 7.4)}{\pgfbox[right,base]{\tikz{\filldraw[fill=dianablue, draw=none] (0 cm, 0 cm) rectangle (50 cm, 1 cm);}\mbox{\hspace{-8 cm}\includegraphics[height=1 cm]{princeton-logo.png}\includegraphics[height=1 cm]{diana-hep-logo.png}}}}}

% Uncomment these lines for an automatically generated outline.
%\begin{frame}{Outline}
%  \tableofcontents
%\end{frame}

% START START START START START START START START START START START START START

%% \begin{frame}{(Everybody take a look at the ZEBRA manual!)}
%% \vspace{0.6 cm}
%% \begin{center}
%% \includegraphics[height=6 cm]{scotty.jpg}

%% \LARGE ``Hello, computer?''
%% \end{center}
%% \end{frame}

%% \begin{frame}{``Data bank'' management systems}
%% \vspace{0.25 cm}
%% \begin{center}
%% \includegraphics[width=0.95\linewidth]{history.pdf}
%% \end{center}
%% \end{frame}

%% \begin{frame}{File formats {\it and specifications}}
%% \vspace{0.5 cm}
%% \begin{columns}
%% \column{1.1\linewidth}
%% \renewcommand{\arraystretch}{1.5}
%% \begin{tabular}{l c c c}
%% & inception & specification & implementations \\\hline

%% FITS & 1981 & \href{https://fits.gsfc.nasa.gov/standard30/fits_standard30aa.pdf}{\textcolor{blue}{\tiny https://fits.gsfc.nasa.gov/standard30/fits\_standard30aa.pdf}} & 38 \\

%% netCDF,HDF4/5 & 1992 & \href{https://support.hdfgroup.org/HDF5/doc/H5.format.html}{\textcolor{blue}{\tiny https://support.hdfgroup.org/HDF5/doc/H5.format.html}} & 35 \\

%% ROOT & 1995 & {\tiny some class headers like \href{https://root.cern.ch/doc/master/classTFile.html}{\textcolor{blue}{TFile}} and \href{https://root.cern.ch/doc/master/classTKey.html}{\textcolor{blue}{TKey}}; not enough info to read a file} & 6 \\

%% Pickle & 1996 & {\tiny {\it implementation} changes: 1$\to$2 \href{http://legacy.python.org/dev/peps/pep-0307/}{\textcolor{blue}{PEP-307}}, 3$\to$4 \href{https://www.python.org/dev/peps/pep-3154/}{\textcolor{blue}{PEP-3154}}; not a real spec} & 4 \\

%% Protocol buffers & 2001 & \href{https://developers.google.com/protocol-buffers/docs/encoding}{\textcolor{blue}{\tiny https://developers.google.com/protocol-buffers/docs/encoding}} & 20 \\

%% Thrift & 2007 & {\tiny {\bf UNOFFICIAL:} \href{https://erikvanoosten.github.io/thrift-missing-specification/}{\textcolor{blue}{\tiny https://erikvanoosten.github.io/thrift-missing-specification/}}} & 15 \\

%% Avro & 2009 & \href{http://avro.apache.org/docs/current/spec.html}{\textcolor{blue}{\tiny http://avro.apache.org/docs/current/spec.html}} & 13 \\

%% Parquet & 2013 & \href{http://parquet.apache.org/documentation/latest/}{\textcolor{blue}{\tiny http://parquet.apache.org/documentation/latest/}} & 5 \\

%% Arrow/Feather & 2016 & \href{https://arrow.apache.org/docs/memory_layout.html}{\textcolor{blue}{\tiny https://arrow.apache.org/docs/memory\_layout.html}} & 7 \\
%% \end{tabular}
%% \end{columns}
%% \end{frame}

%% \begin{frame}
%% \vspace{1 cm}
%% \begin{columns}
%% \column{0.7\linewidth}
%% \includegraphics[width=\linewidth]{specs.pdf}

%% \column{0.35\linewidth}
%% \textcolor{darkblue}{\underline{General trend}}

%% \vspace{0.1 cm}
%% File formats that are used for many years accumulate implementations, to access the data in different ways.

%% \small

%% \vspace{0.4 cm}
%% \uncover<2->{\textcolor{darkblue}{Outlier:} netCDF/HDF4/5 may be too broad to call one format.}

%% \vspace{0.2 cm}
%% \uncover<3->{\textcolor{darkblue}{Outlier:} Python Pickle is only reimplemented when the language is reimplemented.}

%% \vspace{0.2 cm}
%% \uncover<4->{\textcolor{darkblue}{Outlier:} the ROOT format is defined by its implementation, not a specification, making it hard to reimplement.}

%% \end{columns}
%% \end{frame}

%% \begin{frame}{ROOT I/O implementations}
%% \vspace{0.25 cm}
%% \begin{columns}
%% \column{1.1\linewidth}
%% \renewcommand{\arraystretch}{1.6}
%% \begin{tabular}{p{2 cm} c p{4.7 cm} p{5.25 cm}}
%% \centering ROOT & C++ & ROOT itself. & The ROOT Team \\
%% \centering JsRoot & Javascript & For interacting with ROOT in web browsers or standalone & Bertrand Bellenot, Sergey Linev (within the ROOT Team) \\
%% \centering root4j/ spark-root & Java/Scala & For Spark and other Big Data projects that run on Java & Started by Tony Johnson in 2001, updated by Viktor Khristenko \\
%% \centering inlib/exlib & C++ & Intended as an alternative, embedded in GEANT-4 & Guy Barrand \\
%% \centering rootio & Go & go-hep ecosystem in Go & Sebastien Binet \\
%% \centering \only<1>{\textcolor{black}{uproot}}\only<2>{\textcolor{blue}{uproot}} & \only<1>{\textcolor{black}{Python}}\only<2>{\textcolor{blue}{Python}} & \only<1>{\textcolor{black}{For quickly getting ROOT data into Numpy and Pandas for machine learning}}\only<2>{\textcolor{blue}{For quickly getting ROOT data into Numpy and Pandas for machine learning}} & \only<1>{\textcolor{black}{Jim Pivarski (me)}}\only<2>{\textcolor{blue}{Jim Pivarski (me)}} \\
%% & \textcolor{gray}{Rust?} & \textcolor{gray}{(typesafe object ownership} & \mbox{\hspace{-0.7 cm}\textcolor{gray}{without a garbage collector)}} \\
%% \end{tabular}
%% \end{columns}
%% \end{frame}

%% \begin{frame}{Motivations for uproot}
%% \vspace{0.25 cm}
%% \begin{center}
%% \only<1>{\includegraphics[width=0.85\linewidth]{motivations.pdf}}
%% \only<2>{\includegraphics[width=0.85\linewidth]{motivations-2.pdf}}
%% \end{center}
%% \end{frame}

%% \begin{frame}{Let's try something dangerous}
%% \vspace{0.5 cm}
%% \Large
%% \begin{itemize}\setlength{\itemsep}{0.3 cm}
%% \item The safest thing I could do is keep showing high-level slides, without getting into the code itself.
%% \item<2-> It would be more dangerous to attempt a live demo. No matter how well you prepare, the Demo Gods will smite you.
%% \item<3-> Instead, I'm going to ask you to download it and apply it to your own data while I show examples of what {\it should} work.
%% \end{itemize}

%% \large
%% \vspace{0.5 cm}
%% \uncover<4->{You will find bugs. Not all of them will be real. Ask me or a neighbor to take a look at it; if the problem isn't obvious, submit a bug report with a small test file. Thanks!}
%% \end{frame}

%% \begin{frame}[fragile]{Here it goes\ldots}
%% \vspace{0.5 cm}
%% \huge
%% \begin{center}
%% \begin{minipage}{0.8\linewidth}
%% \begin{verbatim}
%% pip install uproot --user
%% \end{verbatim}
%% \end{minipage}

%% \Large
%% \begin{uncoverenv}<2->
%% \vspace{1 cm}
%% \href{https://github.com/scikit-hep/uproot}{\textcolor{blue}{https://github.com/scikit-hep/uproot}}

%% \vspace{0.5 cm}
%% \href{http://uproot.readthedocs.io}{\textcolor{blue}{http://uproot.readthedocs.io}}

%% \vspace{0.5 cm}
%% \href{https://groups.google.com/forum/#!forum/uproot-users/join}{\textcolor{blue}{https://groups.google.com/forum/\#!forum/uproot-users/join}}
%% \end{uncoverenv}
%% \end{center}
%% \end{frame}

%% \begin{frame}{Roadmap and scope}
%% \vspace{0.5 cm}
%% \large
%% \begin{description}\setlength{\itemsep}{0.5 cm}
%% \item[version 1.x] \textcolor{darkblue}{\it (past)} minimalistic, two-week ROOT-to-Numpy project because this feature is delayed in C++ ROOT.

%% \item[version 2.x] \textcolor{darkblue}{\it (current)} a complete rewrite using ROOT streamers to read any data type. Anything can now be read from TDirectories but currently only numbers, strings, and {\tt std::vector<number>} can be read from TTrees.

%% \vspace{0.5 cm}
%% Classes that have been ``split'' (the default) usually satisfy the above.

%% \item[version 3.x] \textcolor{darkblue}{\it (future)} will add the ability to write files. Will be limited to reading from one file and writing to another.
%% \end{description}
%% \end{frame}

%% \begin{frame}{Terminology (may refer back to this slide)}
%% \vspace{0.25 cm}
%% \begin{center}
%% \includegraphics[width=0.9\linewidth]{terminology.pdf}
%% \end{center}
%% \end{frame}

%% \begin{frame}{Levels of trustworthiness}
%% \large
%% \renewcommand{\arraystretch}{4}
%% \begin{tabular}{p{2 cm} p{10 cm}}
%% \parbox[c]{1.5 cm}{\includegraphics[width=1.5 cm]{safe.png}} & The feature in question is an essential part of the codebase; I designed around it and have included a formal test suite. \\
%% \parbox[c]{1.5 cm}{\includegraphics[width=1.5 cm]{caution.png}} & Mostly the same code paths as above and {\it informally} tested, but not yet integrated into the formal tests. \\
%% \parbox[c]{1.5 cm}{\includegraphics[width=1.5 cm]{danger.png}} & I wrote the feature for this talk and have only tested the examples shown here. \\
%% \end{tabular}
%% \end{frame}

%% \begin{frame}[fragile]{The basics: poking around}
%% \vspace{0.1 cm}
%% \small
%% \begin{minted}{python}
%% >>> import uproot
%% >>> f = uproot.open("~/TrackResonanceNtuple.root")
%% >>> f.keys()
%% \end{minted}
%% \begin{verbatim}
%% ['TrackResonanceNtuple;1']
%% \end{verbatim}
%% \begin{minted}{python}
%% >>> f.allkeys()
%% \end{minted}
%% \begin{verbatim}
%% ['TrackResonanceNtuple;1', 'TrackResonanceNtuple/twoTrack;2',
%%  'TrackResonanceNtuple/twoTrack;1',
%%  'TrackResonanceNtuple/twoMuon;1']
%% \end{verbatim}
%% \begin{minted}{python}
%% >>> f.classes()
%% \end{minted}
%% \begin{verbatim}
%% [('TrackResonanceNtuple;1', <class 'uproot.rootio.ROOTDirectory'>)]
%% \end{verbatim}
%% \begin{minted}{python}
%% >>> f["TrackResonanceNtuple"].classes()
%% \end{minted}
%% \begin{verbatim}
%% [('twoTrack;2', <class 'uproot.rootio.TTree'>),
%%  ('twoTrack;1', <class 'uproot.rootio.TTree'>),
%%  ('twoMuon;1', <class 'uproot.rootio.TTree'>)]
%% \end{verbatim}

%% \vspace{-7.6 cm}
%% \hfill \includegraphics[width=1.5 cm]{safe.png}\hspace{-0.9 cm}
%% \vspace{7.5 cm}
%% \end{frame}

%% \begin{frame}[fragile]{The basics: getting data from a TTree}
%% \vspace{0.1 cm}
%% \small
%% \begin{minted}{python}
%% >>> import uproot
%% >>> t = uproot.open("tests/samples/Zmumu.root")["events"]
%% >>> t.keys()
%% \end{minted}
%% \begin{verbatim}
%% ['Type', 'Run', 'Event', 'E1', 'px1', 'py1', 'pz1', 'pt1',
%%  'eta1', 'phi1', 'Q1', 'E2', 'px2', 'py2', 'pz2', 'pt2',
%%  'eta2', 'phi2', 'Q2', 'M']
%% \end{verbatim}
%% \begin{minted}{python}
%% >>> t["M"].array()
%% \end{minted}
%% \begin{verbatim}
%% array([ 82.46269156,  83.62620401,  83.30846467, ...,  95.96547966,
%%         96.49594381,  96.65672765])
%% \end{verbatim}
%% \begin{minted}{python}
%% >>> t.arrays(["px1", "py1", "pz1"])
%% \end{minted}
%% \begin{verbatim}
%% {'py1': array([ 17.433243, -16.5703623, -16.5703623, ..., 1.1994057,
%%  ...
%% \end{verbatim}
%% \begin{minted}{python}
%% >>> t.arrays()    # all of them!
%% \end{minted}
%% \begin{verbatim}
%%  ...
%% \end{verbatim}
%% \vspace{-7.6 cm}
%% \hfill \includegraphics[width=1.5 cm]{safe.png}\hspace{-0.9 cm}
%% \vspace{7.5 cm}
%% \end{frame}

%% \begin{frame}[fragile]{The basics: doing meaningful calculations with them}
%% \vspace{0.5 cm}
%% \small
%% \begin{minted}{python}
%% >>> import numpy
%% >>> for px, py, pz in t.iterate(["px1","py1","pz1"], outputtype=tuple):
%% ...     pt = numpy.sqrt(px**2 + py**2)
%% ...     eta = numpy.arctanh(pz / numpy.sqrt(px**2 + py**2 + pz**2))
%% ...     phi = numpy.arctan2(py, px)
%% ...     print(pt)
%% ...     print(eta)
%% ...     print(phi)
%% ... 
%% \end{minted}
%% \begin{verbatim}
%% [ 44.7322 38.8311  38.8311  ...,  32.3997  32.3997 32.5076  ]
%% [-1.21769 -1.05139 -1.05139 ..., -1.57044 -1.57044 -1.57078 ]
%% [ 2.74126 -0.44087 -0.44087 ...,  0.03702  0.03702  0.036964]
%% \end{verbatim}

%% \vspace{0.5 cm}
%% Also {\tt uproot.iterate("$\sim$/files*.root", "events", ...)} for a collection of files.

%% \vspace{-4.5 cm}
%% \hfill \includegraphics[width=1.5 cm]{safe.png}\hspace{-0.9 cm}
%% \vspace{4.5 cm}
%% \end{frame}

%% \begin{frame}[fragile]{Connector to an external package: Pandas}
%% \vspace{0.25 cm}
%% \small
%% \begin{minted}{bash}
%% $ pip install pandas --user
%% \end{minted}
%% \begin{minted}{python}
%% >>> df = t.pandas.df()   # all the same arguments as t.arrays()
%% >>> df
%% \end{minted}
%% \begin{verbatim}
%%               E1          E2      Event          M  Q1  Q2     Run  \
%% 0      82.201866   60.621875   10507008  82.462692   1  -1  148031
%% 1      62.344929   82.201866   10507008  83.626204  -1   1  148031
%% 2      62.344929   81.582778   10507008  83.308465  -1   1  148031
%% 3      60.621875   81.582778   10507008  82.149373  -1   1  148031
%% ...
%% 2302   1.199406 -26.398400  -74.532431 -153.847604   GT
%% 2303   1.201350 -26.398400  -74.808372 -153.847604   GG

%% [2304 rows x 20 columns]
%% \end{verbatim}

%% \vspace{0.25 cm}
%% Then search the web to learn how to do exploratory analysis, make plots, apply machine learning algorithms, etc. (Or read the {\it Python for Data Analysis} book.)

%% \vspace{-3 cm}
%% \hfill \includegraphics[width=1.5 cm]{caution.png}\hspace{-0.9 cm}
%% \vspace{3 cm}
%% \end{frame}

%% \begin{frame}[fragile]{Accessing data with non-uniform width}
%% \vspace{0.25 cm}
%% \small
%% \begin{minted}{python}
%% >>> t = uproot.open("tests/samples/mc10events.root")["Events"]
%% >>> a = t.array("Muon.pt")    # such as std::vector<numbers>
%% >>> a
%% \end{minted}
%% \begin{verbatim}
%% jaggedarray([[ 28.07074928],
%%              [],
%%              [ 5.52336693  5.4780116 4.13222885],
%%              ...
%%              [],
%%              [ 6.85138178],
%%              []])
%% \end{verbatim}
%% \begin{uncoverenv}<2->
%% \begin{minted}{python}
%% >>> a.contents
%% \end{minted}
%% \begin{verbatim}
%% array([ 28.07074928,   5.52336693,   5.47801161,   4.13222885, ...
%%          5.06344414,   6.85138178], dtype=float32)
%% \end{verbatim}
%% \begin{minted}{python}
%% >>> a.stops
%% \end{minted}
%% \begin{verbatim}
%% array([ 1,  1,  4,  7,  7,  8, 13, 13, 14, 14])
%% \end{verbatim}
%% \end{uncoverenv}

%% \vspace{-7.7 cm}
%% \hfill \includegraphics[width=1.5 cm]{safe.png}\hspace{-0.9 cm}
%% \vspace{7.7 cm}
%% \end{frame}

%% \begin{frame}[fragile]{Also, strings! (any variable-width data type can be a jagged array)}
%% \vspace{0.5 cm}
%% \small
%% \begin{minted}{python}
%% >>> t = uproot.open("tests/samples/sample.root")["sample"]
%% >>> a = t.array("str")
%% >>> a
%% \end{minted}
%% \begin{verbatim}strings(['hey-0' 'hey-1' 'hey-2' ... 'hey-27' 'hey-28' 'hey-29'])
%% \end{verbatim}
%% \begin{uncoverenv}<2->
%% \begin{minted}{python}
%% >>> a.jaggedarray.contents
%% \end{minted}
%% \begin{verbatim}array([104, 101, 121,  45,  48, 104, 101, 121,  45,  49, 104, 101,
%%         121, 45,  50, 104, 101, 121,  45,  51, 104, 101, 121,  45,
%%         ...
%%         45,  50,  54, 104, 101, 121, 45,  50,  55, 104, 101, 121,
%%         45,  50,  56, 104, 101, 121,  45,  50,  57], dtype=uint8)
%% \end{verbatim}
%% \begin{minted}{python}
%% >>> a.jaggedarray.stops
%% \end{minted}
%% \begin{verbatim}array([  5,  10,  15,  20,  25,  30,  35,  40,  45,  50,  56,  62,
%%        ...
%%        152, 158, 164, 170])
%% \end{verbatim}
%% \end{uncoverenv}
%% \vspace{-7.7 cm}
%% \hfill \includegraphics[width=1.5 cm]{safe.png}\hspace{-0.9 cm}
%% \vspace{7.7 cm}
%% \end{frame}

\begin{frame}[fragile]{Including STL vectors in a MiniAOD file}
\vspace{0.25 cm}
\small
\begin{minted}{python}
>>> t = uproot.open("~/cmssw-miniaod.root")["Events"]
\end{minted}
\begin{verbatim}
>>> for basket in (t["GenEventInfoProduct_generator__HLT.obj.weights_"]
                   .iterate_baskets()):
...     print(basket)
...
[[  1.000000e+00   4.201630e-05 ...   4.242230e-05   3.990430e-05],
 [  1.000000e+00   4.201630e-05 ...   2.648060e-05   2.773620e-05],
 [  1.000000e+00   4.201630e-05 ...   4.329220e-05   4.058060e-05],
\end{verbatim}

\vspace{0.25 cm}
Though uproot was designed for analysis-ready TTrees, it will someday cover all data types by reading streamer data.

\hfill \includegraphics[width=1.5 cm]{caution.png}\hspace{-0.9 cm}
\end{frame}

\end{document}
